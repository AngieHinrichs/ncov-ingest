#!/usr/bin/env bash

# Downloads data required for Nextclade to functions and runs nextclade

set -o errexit
set -o nounset
set -o pipefail
trap "exit" INT

: "${1:?\"[ERROR] ${0}: Input fasta filename as the 1st argument is required.\"}"
: "${2:?\"[ERROR] ${0}: Output TSV filename as the 2nd argument is required.\"}"
: "${3:?\"[ERROR] ${0}: Directory for Nextclade input data as the 3rd argument is required.\"}"
: "${4:?\"[ERROR] ${0}: Output directory as the 4th argument is required.\"}"

INPUT_FASTA="${1}"
OUTPUT_TSV="${2}"
NEXTCLADE_INPUTS_DIR="${3}" # external data required for nextclade to function will be downloaded there
NEXTCLADE_OUTPUTS_DIR="${4}" # files other than TSV will be written by Nextclade there (aligned sequences, peptides, etc.)

if ! command -v nextclade &>/dev/null; then
  printf "[ERROR] ${0}:${LINENO}: Nextclade executable not found\n"
  exit 1
fi

NEXTCLADE_VERSION="$(nextclade --version)"
printf "[ INFO] ${0}:${LINENO}: Nextclade version: ${NEXTCLADE_VERSION}\n"

NEXTCLADE_INPUTS_URL_BASE="https://raw.githubusercontent.com/nextstrain/nextclade/${NEXTCLADE_VERSION}/data/sars-cov-2"
printf "[ INFO] ${0}:${LINENO}: Downloading Nextclade input data:\n"
printf "[ INFO] ${0}:${LINENO}:   From: \"${NEXTCLADE_INPUTS_URL_BASE}\"\n"
printf "[ INFO] ${0}:${LINENO}:     To: \"${NEXTCLADE_INPUTS_DIR}\"\n"
mkdir -p "${NEXTCLADE_INPUTS_DIR}"
pushd "${NEXTCLADE_INPUTS_DIR}" >/dev/null
  curl -fsSLOJ "${NEXTCLADE_INPUTS_URL_BASE}/reference.fasta"
  curl -fsSLOJ "${NEXTCLADE_INPUTS_URL_BASE}/genemap.gff"
  curl -fsSLOJ "${NEXTCLADE_INPUTS_URL_BASE}/tree.json"
  curl -fsSLOJ "${NEXTCLADE_INPUTS_URL_BASE}/qc.json"
  curl -fsSLOJ "${NEXTCLADE_INPUTS_URL_BASE}/primers.csv"
popd >/dev/null

printf "[ INFO] ${0}:${LINENO}: Running nextclade\n"
/usr/bin/time -f "[ INFO] ${0}:${LINENO}: Nextclade run statistics: Wall clock time: %E, Maximum resident memory: %M KB\n" \
nextclade \
  --in-order \
  --verbosity=error \
  --input-fasta="data/gisaid/nextclade.sequences.fasta" \
  --output-tsv="data/gisaid/nextclade.tsv" \
  --input-root-seq="${NEXTCLADE_INPUTS_DIR}/reference.fasta" \
  --input-gene-map="${NEXTCLADE_INPUTS_DIR}/genemap.gff" \
  --input-tree="${NEXTCLADE_INPUTS_DIR}/tree.json" \
  --input-qc-config="${NEXTCLADE_INPUTS_DIR}/qc.json" \
  --input-pcr-primers="${NEXTCLADE_INPUTS_DIR}/primers.csv" \
  --genes=E,M,N,ORF1a,ORF1b,ORF3a,ORF6,ORF7a,ORF7b,ORF8,ORF9b,S \
  --output-dir="${NEXTCLADE_OUTPUTS_DIR}" \
  --output-basename="nextclade"
