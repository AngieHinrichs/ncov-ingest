#!/bin/bash
# usage: ./bin/fetch-data
#
# Fetches the latest novel coronavirus data from GISAID.
#
# Required environment variables:
#  * GISAID_API_ENDPOINT - the URL used to GET nCoV data from GISAID
#  * GISAID_USERNAME_AND_PASSWORD - a username:password combination for basic
#                                   authentication to the GISAID API endpoint.
#  * SLACK_INCOMING_WEBHOOK - an incoming webhook used to send Slack messages.
#
# Options:
#  * --help - View this help message.
#  * --slack - Send a Slack notification to #ncov if there are new nCoV data.
#  * --upload - Upload the fetched GISAID data to a private S3 bucket.
#

set -euo pipefail
cd "$(dirname "$0")/.."

GISAID_API_ENDPOINT=${GISAID_API_ENDPOINT:-'http://'}
GISAID_USERNAME_AND_PASSWORD=${GISAID_USERNAME_AND_PASSWORD:-'username:password'}

main() {
    local SLACK=0
    local UPLOAD=0

    for arg; do
        case "$arg" in
            -h|--help)
                print-help
                exit
                ;;
            --slack)
                SLACK=1
                shift
                ;;
            --upload)
                UPLOAD=1
                shift
                break
                ;;
            *)
        esac
    done

    if [[ $# -gt 0 ]]; then
        echo "Error: extra arguments provided; aborting out of an abundance of caution." >&2
        echo
        print-help
        exit 1
    fi

    NCOV_ZIP_FILE="corona2020_fulldump.json.bz2"
    NCOV_DATA_FILE="corona2020_fulldump.json"

    if [[ ! -d "data" ]]; then
        mkdir data
    fi

    trap "rm 'data/$NCOV_ZIP_FILE'" EXIT

    echo "Retrieving latest nCoV data from GISAID"
    curl -X GET $GISAID_API_ENDPOINT \
        -u "$GISAID_USERNAME_AND_PASSWORD" \
        --output "data/$NCOV_ZIP_FILE"
    echo

    echo "Unzipping the downloaded data"
    bunzip2 -kf "data/$NCOV_ZIP_FILE"
    echo

    echo "Diffing the recently downloaded data against what's stored on S3"

    # Digest the old nCoV file on s3
    hash="$(aws s3 cp s3://nextstrain-ncov-private/corona2020_fulldump.json - | sha256sum | cut -d ' ' -f 1)"

    # Compare the digest of the old nCoV file with the recently downloaded one
    if [[ "$hash" != "$(sha256sum "data/$NCOV_DATA_FILE" | cut -d ' ' -f 1)" ]]; then
        echo "The remote GISAID dataset does not match the most recent download"

        if [[ $SLACK -eq 1 ]]; then
            echo "Alerting via Slack"
            curl -X POST -H 'Content-type: application/json' \
                --data \
                '{
                    "text": "@channel: New nCoV data found on GISAID.",
                    "blocks": [{
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": ":rotating_light: @channel New nCoV data found on GISAID."
                        }
                    }]
                }' \
                $SLACK_INCOMING_WEBHOOK
        fi
        echo
    fi


    if [[ $UPLOAD -eq 1 ]]; then
        echo "Uploading latest nCoV data from GISAID to private S3 bucket"
        aws s3 cp "data/$NCOV_DATA_FILE" s3://nextstrain-ncov-private/
        echo
    fi
}

print-help() {
    # Print the help comments at the top of this file ($0)
    perl -MEnglish -ne '
        s/^# ?// or exit;
        print if $INPUT_LINE_NUMBER >= 2;
    ' "$0"
}

main "$@"
