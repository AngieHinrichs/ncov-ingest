#!/bin/bash
set -euo pipefail

: "${SLACK_INCOMING_WEBHOOK:?The SLACK_INCOMING_WEBHOOK environment variable is required.}"

bin="$(dirname "$0")"

if [[ -d "ncov" ]]; then
    echo "Downloading latest version of the ncov repo (master branch)"
    (cd ncov; git pull)
else
    echo "Cloning the ncov repo"
    git clone https://github.com/nextstrain/ncov.git
fi


output=$(
    nextstrain build --aws-batch --detach \
        ncov deploy_to_staging \
        --config slack_webhook="$SLACK_INCOMING_WEBHOOK"
)

echo "$output"

# Extract the AWS job ID from the `nextstrain build --aws-batch --detach` output
aws_batch_job_id=$(grep "AWS Batch Job ID" <<<"$output" | cut -d ' ' -f 5)

echo "Notifying Slack about metadata change."
"$bin"/notify-slack "A new batch job has started. Follow along with" <<<"nextstrain build --aws-batch --attach $aws_batch_job_id"
