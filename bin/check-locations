#!/usr/bin/env python3
"""
Validates the locations in the metadata TSV file produced by the transform
scripts.
"""
import copy
import argparse
import pandas as pd
from pathlib import Path
from typing import List


LOCATION_HIERARCHY_COLUMNS = ['region', 'country', 'division']


def validate_metadata(metadata: pd.DataFrame, columns: List[str]):
    def no_missing_hierarchy_data():
        """
        Raises an ``AssertionError`` if the metadata have missing values in the
        given location hierarchy *columns*.
        """
        non_null_columns = columns.copy()

        non_null_columns += [ f"{resolution}_exposure" for resolution in non_null_columns ]

        assert metadata[non_null_columns].notnull().all().all(), \
            "There are missing values in the location hierarchy columns " \
            f"«{non_null_columns}». At this point, we expect all " \
            "missing values to be interpolated."

    no_missing_hierarchy_data()


parser = argparse.ArgumentParser(
    description="Validate a metadata TSV file generated by a transform script",
    formatter_class=argparse.RawTextHelpFormatter
)
parser.add_argument("metadata",
    help="A metadata TSV file.")

args = parser.parse_args()

metadata = pd.read_csv(args.metadata, sep="\t")
validate_metadata(metadata, LOCATION_HIERARCHY_COLUMNS)
