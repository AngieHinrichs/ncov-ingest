#!/bin/bash
set -euo pipefail

: "${SLACK_INCOMING_WEBHOOK:?The SLACK_INCOMING_WEBHOOK environment variable is required.}"
: "${SLACK_TOKEN:?The SLACK_TOKEN environment variable is required.}"
: "${SLACK_CHANNELS:=#ncov-gisaid-updates}"

upload=0
args=()

for arg; do
    case "$arg" in
        --upload)
            upload=1;;
        *)
            args+=("$arg");;
    esac
done

set -- "${args[@]}"

text="${1:?Some message text is required.}"

if [[ "$upload" == 1 ]]; then
    echo "Uploading data to Slack with the message: $text"
    curl https://slack.com/api/files.upload \
        --header "Authorization: Bearer $SLACK_TOKEN" \
        --form-string channels="$SLACK_CHANNELS" \
        --form-string title="$text" \
        --form file=@/dev/stdin \
        --form filetype=text \
        --fail --silent --show-error \
        --include
else
    slack_message="$(jq '{"text": $text}' --arg text "$text" --null-input)"

    echo "Posting Slack message: $slack_message"
    curl "$SLACK_INCOMING_WEBHOOK" \
        --header 'Content-type: application/json' \
        --data-raw "$slack_message" \
        --fail --silent --show-error \
        --include
fi
