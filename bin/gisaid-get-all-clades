#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail
trap "exit" INT

TMP_DIR="data/gisaid/tmp"

# Load environment variables from these files, if exist
[ -f ".env" ] && source ".env"
[ -f "../.env" ] && source "../.env"

: "${GISAID_USERNAME:?The GISAID_USERNAME environment variable is required.}"
: "${GISAID_PASSWORD:?The GISAID_PASSWORD environment variable is required.}"
: "${GISAID_URL:?The GISAID_URL environment variable is required.}"

mkdir -p "${TMP_DIR}"

# Get .ndjson
wget \
  --directory-prefix="${TMP_DIR}" \
  --http-user="${GISAID_USERNAME}" \
  --http-password="${GISAID_PASSWORD}" \
  "${GISAID_URL}" \
  -O "${TMP_DIR}/gisaid.ndjson.bz2"

bzip2 -cdk "${TMP_DIR}/gisaid.ndjson.bz2" >"data/gisaid/gisaid.ndjson"

./bin/transform-gisaid "data/gisaid/gisaid.ndjson" \
  --output-metadata "data/gisaid/metadata.tsv" \
  --output-fasta "data/gisaid/sequences.fasta" \
  --output-unix-newline

./bin/run-nextclade \
  "data/gisaid/nextclade.sequences.fasta" \
  "data/gisaid/nextclade.tsv"

./bin/join-metadata-and-clades \
  "data/gisaid/metadata.tsv" \
  "data/gisaid/nextclade.tsv" \
  -o "data/gisaid/metadata.tsv"
