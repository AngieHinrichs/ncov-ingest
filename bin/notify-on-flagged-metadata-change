#!/bin/bash
set -euo pipefail

: "${SLACK_TOKEN:?The SLACK_TOKEN environment variable is required.}"

bin="$(dirname "$0")"

src="${1:?A source flagged metadata txt file is required as the first argument.}"
dst="${2:?A destination flagged metadata txt s3:// URL is required as the second argument.}"

dst_local="$(mktemp -t flagged-metadata-XXXXXX.txt)"

diff="$(mktemp -t flagged-metadata-additions-XXXXXX)"

trap "rm -f '$dst_local' '$diff'" EXIT

aws s3 cp --no-progress "$dst" - | gunzip -cfq > "$dst_local"

comm -13 \
    <(sort "$dst_local") \
    <(sort "$src") \
    > "$diff"

if [[ -s "$diff" ]]; then
    echo
    echo "Notifying Slack about flagged metadata additions."
    "$bin"/notify-slack ":waving_black_flag: Newly flagged metadata"
    "$bin"/notify-slack --upload "flagged-metadata-additions.txt" < "$diff"
else
    echo "No flagged metadata additions."
fi
