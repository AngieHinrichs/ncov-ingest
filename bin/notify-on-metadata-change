#!/bin/bash
set -euo pipefail

: "${SLACK_TOKEN:?The SLACK_TOKEN environment variable is required.}"

bin="$(dirname "$0")"

src="${1:?A source metadata TSV file is required as the first argument.}"
dst="${2:?A destination metadata TSV s3:// URL ending in .gz is required as the second argument.}"

if [[ "$dst" != *.gz ]]; then
    echo "The given destination s3:// URL must point to a gzip file ending in .gz"
    exit 1
fi

diff="$(
    csv-diff \
        <(aws s3 cp --no-progress "$dst" - | gunzip) \
        "$src" \
        --format tsv \
        --key gisaid_epi_isl \
        --singular sequence \
        --plural sequences
)"

if [[ -n "$diff" ]]; then
    echo "Notifying Slack about metadata change."
    "$bin"/notify-slack --upload "Metadata changes" <<<"$diff"
else
    echo "No metadata change."
fi
